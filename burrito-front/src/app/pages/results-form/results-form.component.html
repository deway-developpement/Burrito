<app-background-div>

<div class="results-form-container">
  <!-- Navigation Bar -->
  <div class="nav-bar">
    <app-go-back></app-go-back>
    <h1 class="page-title" i18n="@@resultsForm.title">Form Results</h1>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p i18n="@@resultsForm.loading">Loading analytics...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-banner">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span>{{ error() }}</span>
      <button class="btn-retry" (click)="onRefreshAnalytics()"><span i18n="@@resultsForm.retry">Retry</span></button>
    </div>
  }

  <!-- Main Content -->
  @if (!loading() && analytics()) {
    <div class="results-content">
      <!-- Header Section -->
      <div class="header-section">
        <div class="form-info">
          <h1>{{ analytics()!.formTitle }}</h1>
        </div>

        <!-- Time Window Selector -->
        <div class="time-window-selector">
          @for (window of timeWindowOptions; track window) {
            <button
              [class.active]="timeWindow() === window"
              (click)="onTimeWindowChange(window)"
              class="time-btn"
            >
              {{ getTimeWindowLabel(window) }}
            </button>
          }
        </div>

        <!-- Custom Date Range Picker -->
        @if (timeWindow() === 'custom') {
          <div class="custom-date-picker">
            <div class="date-input-group">
              <label for="from-date" i18n="@@resultsForm.fromLabel">From</label>
              <input
                id="from-date"
                type="date"
                [valueAsDate]="customFromDate()"
                (change)="onCustomFromDateChange($event)"
                class="date-input"
              />
            </div>
            <div class="date-input-group">
              <label for="to-date" i18n="@@resultsForm.toLabel">To</label>
              <input
                id="to-date"
                type="date"
                [valueAsDate]="customToDate()"
                (change)="onCustomToDateChange($event)"
                class="date-input"
              />
            </div>
          </div>
        }
      </div>

      @if (hasResponses()) {
        <!-- Response Summary (Hero Section) -->
        <div class="response-summary">
          <div class="summary-stats">
            <div class="stat satisfaction-breakdown-stat">
              <div class="stat-label" i18n="@@resultsForm.satisfactionBreakdown">Satisfaction Breakdown</div>
              <div class="satisfaction-breakdown">
                <div class="breakdown-item promoters">
                  <span class="breakdown-label" i18n="@@resultsForm.promoters">Promoters</span>
                  <span class="breakdown-value">{{ analytics()!.nps.promotersPct.toFixed(1) }}% ({{ analytics()!.nps.promotersCount }})</span>
                </div>
                <div class="breakdown-item passives">
                  <span class="breakdown-label" i18n="@@resultsForm.passives">Passives</span>
                  <span class="breakdown-value">{{ analytics()!.nps.passivesPct.toFixed(1) }}% ({{ analytics()!.nps.passivesCount }})</span>
                </div>
                <div class="breakdown-item detractors">
                  <span class="breakdown-label" i18n="@@resultsForm.detractors">Detractors</span>
                  <span class="breakdown-value">{{ analytics()!.nps.detractorsPct.toFixed(1) }}% ({{ analytics()!.nps.detractorsCount }})</span>
                </div>
              </div>
            </div>

            @if (!isTeacherView()) {
              <div class="stat nps-stat">
                <div
                  class="stat-value"
                  [style.background]="getNpsGradient(analytics()!.nps.score)"
                  [style.-webkit-background-clip]="'text'"
                  [style.background-clip]="'text'"
                  [style.-webkit-text-fill-color]="'transparent'"
                >
                  {{ analytics()!.nps.score.toFixed(0) }}
                </div>
                <div class="stat-label">NPS Score</div>
              </div>
            }

            <div class="stat">
              <div class="stat-value">{{ analytics()!.totalResponses }}</div>
              <div class="stat-label" i18n="@@resultsForm.totalResponses">Total Responses</div>
            </div>
          </div>
        </div>

        <!-- Teachers Breakdown (Admin Only) -->
        @if (isAdmin()) {
          <div class="teachers-breakdown">
            <h2 class="section-title" i18n="@@resultsForm.teachersBreakdown">Teachers Breakdown</h2>
            <div class="teachers-table-container">
              <table class="teachers-table">
                <thead>
                  <tr>
                    <th i18n="@@resultsForm.teacherName">Teacher Name</th>
                    <th i18n="@@resultsForm.responses">Responses</th>
                    <th i18n="@@resultsForm.nps">NPS</th>
                    <th i18n="@@resultsForm.avgRating">Avg Rating</th>
                    <th i18n="@@resultsForm.action">Action</th>
                  </tr>
                </thead>
                <tbody>
                  @for (teacher of analytics()!.teachersBreakdown; track teacher.teacherId) {
                    <tr class="teacher-row">
                      <td class="teacher-name">{{ teacher.teacherName }}</td>
                      <td>{{ teacher.totalResponses }}</td>
                      <td>
                        <span [class]="getTeacherBadgeClass(teacher.nps.score)">
                          {{ teacher.nps.score.toFixed(0) }}
                        </span>
                      </td>
                      <td>{{ teacher.averageRating.toFixed(1) }}/10</td>
                      <td class="action-cell">
                        <button class="btn-view" (click)="navigateToTeacherResults(teacher.teacherId)" (keydown.enter)="navigateToTeacherResults(teacher.teacherId)">
                          <span i18n="@@resultsForm.viewResults">View Results</span> ‚Üí
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }

        <!-- Per-Question Breakdown -->
        <div class="questions-breakdown">
          <h2 class="section-title" i18n="@@resultsForm.perQuestion">Per-Question Breakdown</h2>

          @for (question of analytics()!.questions; track question.questionId) {
            <div class="question-card">
              <button
                type="button"
                class="question-header"
                (click)="toggleQuestionExpanded(question.questionId)"
                (keydown.enter)="toggleQuestionExpanded(question.questionId)"
                (keydown.space)="toggleQuestionExpanded(question.questionId)"
              >
                <div class="question-title">
                  <span class="expand-icon">
                    {{ isQuestionExpanded(question.questionId) ? '‚ñº' : '‚ñ∂' }}
                  </span>
                  <h3>{{ question.label }}</h3>
                </div>
                <div class="question-meta">
                  <span class="answered-count" i18n="@@resultsForm.answeredCount">{{ question.answeredCount }} answered</span>
                </div>
              </button>

              @if (isQuestionExpanded(question.questionId)) {
                <div class="question-content">
                  <!-- Rating Question -->
                  @if (question.rating) {
                    <div class="rating-breakdown">
                      <div class="rating-stats">
                        <div class="stat-box">
                          <span class="stat-label" i18n="@@resultsForm.average">Average</span>
                          <span class="stat-value">{{ question.rating.avg.toFixed(2) }}/10</span>
                        </div>
                      </div>

                      <div class="rating-distribution">
                        <h4 i18n="@@resultsForm.distribution">Distribution</h4>
                        @for (bucket of question.rating.distribution; track bucket.rating) {
                          <div class="distribution-item">
                            <span class="rating-label">{{ bucket.rating }} ‚≠ê</span>
                            <div class="rating-bar">
                              <div
                                class="bar-fill"
                                [style.width.%]="(bucket.count / question.answeredCount) * 100"
                              ></div>
                            </div>
                            <span class="count">{{ bucket.count }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Text Question -->
                  @if (question.text) {
                    <div class="text-breakdown">
                      <!-- Analysis Disabled Message -->
                      @if (question.text.analysisStatus === 'DISABLED') {
                        <div class="analysis-unavailable">
                          <span class="icon">‚ö†Ô∏è</span>
                          <p i18n="@@resultsForm.analysisDisabled">Text analysis is disabled for this question.</p>
                        </div>
                      }

                      <!-- Analysis Failed Message -->
                      @if (question.text.analysisStatus === 'FAILED') {
                        <div class="analysis-failed">
                          <span class="icon">‚ùå</span>
                          <p i18n="@@resultsForm.analysisFailed">Text analysis failed. Unable to generate summary for this question.</p>
                        </div>
                      }

                      <!-- Analysis Pending Message -->
                      @if (question.text.analysisStatus === 'PENDING') {
                        <div class="analysis-pending">
                          <span class="icon">‚è≥</span>
                          <p i18n="@@resultsForm.analysisPending">Text analysis is in progress. Summary will be available soon.</p>
                        </div>
                      }

                      <!-- Analysis Ready - Sentiment and Ideas -->
                      @if (question.text.analysisStatus === 'READY') {
                        <!-- Sentiment Analysis -->
                        @if (question.text.sentiment) {
                          <div class="sentiment-analysis">
                            <h4 i18n="@@resultsForm.sentiment">Sentiment</h4>
                            <div class="sentiment-breakdown">
                              <div class="sentiment-item positive">
                                <span class="sentiment-label" i18n="@@resultsForm.positive">Positive</span>
                                <span class="sentiment-bar">
                                  <div class="bar-fill" [style.width.%]="question.text.sentiment.positivePct"></div>
                                </span>
                                <span class="sentiment-pct">{{ question.text.sentiment.positivePct.toFixed(1) }}%</span>
                              </div>
                              <div class="sentiment-item neutral">
                                <span class="sentiment-label" i18n="@@resultsForm.neutral">Neutral</span>
                                <span class="sentiment-bar">
                                  <div class="bar-fill" [style.width.%]="question.text.sentiment.neutralPct"></div>
                                </span>
                                <span class="sentiment-pct">{{ question.text.sentiment.neutralPct.toFixed(1) }}%</span>
                              </div>
                              <div class="sentiment-item negative">
                                <span class="sentiment-label" i18n="@@resultsForm.negative">Negative</span>
                                <span class="sentiment-bar">
                                  <div class="bar-fill" [style.width.%]="question.text.sentiment.negativePct"></div>
                                </span>
                                <span class="sentiment-pct">{{ question.text.sentiment.negativePct.toFixed(1) }}%</span>
                              </div>
                            </div>
                          </div>
                        }

                        <!-- Top Ideas -->
                        @if (question.text.topIdeas && question.text.topIdeas.length > 0) {
                          <div class="top-ideas">
                            <h4 i18n="@@resultsForm.topIdeas">Top Ideas</h4>
                            @for (idea of question.text.topIdeas; track idea.idea) {
                              <div class="idea-item">
                                <span class="idea-text">{{ idea.idea }}</span>
                                <span class="idea-count">{{ idea.count }}x</span>
                              </div>
                            }
                          </div>
                        }
                      }

                      <!-- Show Details Button (always visible) -->
                      <div class="text-stats">
                        <button class="btn-show-answers" (click)="openTextResponses(question.questionId)" i18n="@@resultsForm.showDetails">Show details</button>
                        <span class="stat-value">{{ question.text.responseCount }}</span>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <!-- Refresh Info -->
        <div class="refresh-info">
          <span class="refresh-timestamp" i18n="@@resultsForm.lastUpdated">Last updated {{ formatDate(analytics()!.generatedAt) }}</span>
          <button (click)="onRefreshAnalytics()" class="btn-refresh">
            @if (loading()) {
              <span class="spinner-small"></span>
            } @else {
              üîÑ <span i18n="@@resultsForm.refresh">Refresh</span>
            }
          </button>
        </div>
      } @else {
        <div class="empty-state">
          <div class="empty-card">
            <div class="empty-illustration" aria-hidden="true">
              <div class="empty-ring">0</div>
            </div>
            <h2 class="empty-title" i18n="@@resultsForm.noResponsesTitle">No responses yet</h2>
            <p class="empty-subtitle" i18n="@@resultsForm.noResponsesSubtitle">
              This form has no evaluations for {{ getTimeWindowLabel(timeWindow()) }}.
            </p>
            <p class="empty-note" i18n="@@resultsForm.noResponsesNote">
              Once the first responses arrive, the dashboard will populate automatically.
            </p>
            <div class="empty-actions">
              <button class="btn-primary" (click)="onRefreshAnalytics()" i18n="@@resultsForm.refresh">Refresh</button>
              @if (timeWindow() !== 'all') {
                <button class="btn-secondary" (click)="onTimeWindowChange('all')" i18n="@@resultsForm.viewAllTime">View all time</button>
              }
            </div>
          </div>
        </div>
      }
    </div>
  }

  @if (textModalOpen()) {
    <div class="modal-overlay" (click)="closeTextResponses()" (keydown.escape)="closeTextResponses()">
      <div class="modal-content" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ currentQuestionId() ? getQuestionLabel(currentQuestionId()!) : textResponsesTitle }}</h3>
          <button class="close-btn" (click)="closeTextResponses()" (keydown.enter)="closeTextResponses()" i18n-aria-label="@@resultsForm.closeLabel" aria-label="Close">‚úï</button>
        </div>

        @if (textLoading()) {
          <div class="modal-loading" i18n="@@resultsForm.loadingTextResponses">Loading text responses...</div>
        } @else if (textError()) {
          <div class="modal-error">{{ textError() }}</div>
        } @else if (textResponses().length > 0) {
          <div class="text-responses" (scroll)="onTextModalScroll($event)">
            @for (resp of textResponses(); track resp.id) {
              <div class="text-response">
                <div class="tr-meta">
                  <span class="pill neutral">{{ resp.questionLabel }}</span>
                  <span class="muted">{{ formatDate(resp.createdAt) }}</span>
                </div>
                <p class="tr-text">{{ resp.text }}</p>
              </div>
            }
            
            @if (textLoadingMore()) {
              <div class="modal-loading-more">
                <div class="spinner-small"></div>
                <span>Loading more...</span>
              </div>
            }
          </div>
        } @else {
          <div class="modal-empty" i18n="@@resultsForm.noTextResponses">No text responses found for this window.</div>
        }
      </div>
    </div>
  }
</div>
</app-background-div>


