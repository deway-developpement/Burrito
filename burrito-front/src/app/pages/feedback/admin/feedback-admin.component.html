<app-background-div class="admin">
  <div class="nav-bar">
    <app-go-back></app-go-back>
  </div>
  
  <main class="admin__main">
    <section class="admin__hero">
      <div class="admin__heading">
        <div class="nav-bar">
          <h1 class="admin__title">{{ pageTitle }}</h1>
        </div>
      </div>
    </section>

    <section class="admin__card">
      <form class="builder" (ngSubmit)="onPublish()">
        <div class="builder__section">
          <div class="section-header">
            <h2 i18n="@@feedbackAdmin.metadataTitle">Form metadata</h2>
            <p i18n="@@feedbackAdmin.metadataSubtitle">
              Students will see this at the top of the form.
            </p>
          </div>

          <div class="builder__grid">
            <div class="form-field">
              <label for="formTitle" class="form-label" i18n="@@feedbackAdmin.formTitleLabel">
                Form title <span class="required">*</span>
              </label>
              <app-input
                id="formTitle"
                variant="primary"
                i18n-placeholder="@@feedbackAdmin.formTitlePlaceholder"
                placeholder="e.g. Semester feedback"
                [fullWidth]="true"
                [(model)]="formTitle"
                [required]="true"
              ></app-input>
            </div>

            <div class="form-field">
              <label for="targetTeacher" class="form-label" i18n="@@feedbackAdmin.targetTeacherLabel">
                Target teacher <span class="required">*</span>
              </label>
              <app-select
                id="targetTeacher"
                variant="outline"
                i18n-placeholder="@@feedbackAdmin.targetTeacherPlaceholder"
                placeholder="Select a teacher"
                [fullWidth]="true"
                [options]="teacherOptions"
                [disabled]="isLoadingTeachers"
                [(value)]="targetTeacherId"
              ></app-select>
            </div>

            <div class="form-field form-field--full">
              <label for="groupPicker" class="form-label" i18n="@@feedbackAdmin.groupsLabel">
                Groups <span class="required">*</span>
              </label>
              <div class="group-picker">
                <div class="group-picker__select">
                  <app-select
                    id="groupPicker"
                    variant="outline"
                    i18n-placeholder="@@feedbackAdmin.groupsPlaceholder"
                    placeholder="select a group"
                    [fullWidth]="true"
                    [options]="availableGroupOptions"
                    [disabled]="isLoadingGroups"
                    [required]="true"
                    [value]="groupSelectValue"
                    (valueChange)="onGroupSelect($event)"
                  ></app-select>
                </div>
                <div class="group-picker__selected">
                  @if (selectedGroupIds.length === 0) {
                    <span class="group-picker__empty" i18n="@@feedbackAdmin.noGroupsSelected">
                      No groups selected
                    </span>
                  }
                  @for (groupId of selectedGroupIds; track groupId) {
                    <button
                      type="button"
                      class="group-pill"
                      (click)="removeGroup(groupId)"
                      [attr.aria-label]="getGroupRemoveLabel(groupId)"
                    >
                      <span class="group-pill__label">{{ getGroupLabel(groupId) }}</span>
                      <span class="group-pill__remove">x</span>
                    </button>
                  }
                </div>
              </div>
              @if (publishAttempted && selectedGroupIds.length === 0) {
                <span class="field-error" i18n="@@feedbackAdmin.groupRequired">Group is required.</span>
              }
            </div>

            <div class="form-field">
              <label for="startDate" class="form-label">
                <span i18n="@@feedbackAdmin.startDateLabel">Start date</span>
                @if (requiresSchedule) {
                  <span class="required">*</span>
                }
              </label>
              <app-input
                id="startDate"
                type="date"
                variant="outline"
                [fullWidth]="true"
                [(model)]="startDate"
              ></app-input>
              @if (publishAttempted && requiresSchedule && !startDate) {
                <span class="field-error" i18n="@@feedbackAdmin.startDateRequired">
                  Start date is required.
                </span>
              }
            </div>

            <div class="form-field">
              <label for="endDate" class="form-label">
                <span i18n="@@feedbackAdmin.endDateLabel">End date</span>
                @if (requiresSchedule) {
                  <span class="required">*</span>
                }
              </label>
              <app-input
                id="endDate"
                type="date"
                variant="outline"
                [fullWidth]="true"
                [(model)]="endDate"
              ></app-input>
              @if (publishAttempted && requiresSchedule && !endDate) {
                <span class="field-error" i18n="@@feedbackAdmin.endDateRequired">
                  End date is required.
                </span>
              }
            </div>
          </div>

          <div class="form-field form-field--full">
            <label for="formDescription" class="form-label" i18n="@@feedbackAdmin.introTextLabel">
              Intro text <span class="required">*</span>
            </label>
            <textarea
              id="formDescription"
              class="form-textarea"
              rows="3"
              i18n-placeholder="@@feedbackAdmin.introTextPlaceholder"
              placeholder="Explain what you expect from students"
              [(ngModel)]="formDescription"
              name="formDescription"
              required
            ></textarea>
            @if (publishAttempted && !formDescription.trim()) {
              <span class="field-error" i18n="@@feedbackAdmin.descriptionRequired">
                Description is required.
              </span>
            }
          </div>
        </div>

        <div class="builder__section">
          <div class="section-header">
            <h3 i18n="@@feedbackAdmin.questionsTitle">Questions *</h3>
            <p i18n="@@feedbackAdmin.questionsSubtitle">
              Combine ratings and short answers to keep it actionable.
            </p>
          </div>

          <div class="questions">
            @for (question of questions; track question.id) {
              <div class="question-card">
                <div class="question-card__header">
                  <span class="pill pill--ghost question-card__type-pill">
                    {{ getQuestionCardLabel(question.type) }}
                  </span>
                  <div class="question-card__actions">
                    <label class="checkbox">
                      <input
                        type="checkbox"
                        [(ngModel)]="question.required"
                        [ngModelOptions]="{ standalone: true }"
                      />
                      <span i18n="@@feedbackAdmin.required">Required</span>
                    </label>
                    <button type="button" class="link-button" (click)="removeQuestion(question.id)" i18n="@@feedbackAdmin.remove">
                      Remove
                    </button>
                  </div>
                </div>

                <div class="form-field">
                  <label [for]="'question-label-' + question.id" class="form-label" i18n="@@feedbackAdmin.questionTextLabel">
                    Question text <span class="required">*</span>
                  </label>
                  <app-input
                    [id]="'question-label-' + question.id"
                    variant="primary"
                    i18n-placeholder="@@feedbackAdmin.questionTextPlaceholder"
                    placeholder="e.g. How clear were the explanations?"
                    [fullWidth]="true"
                    [(model)]="question.label"
                    [required]="true"
                  ></app-input>
                  @if (publishAttempted && !question.label.trim()) {
                    <span class="field-error" i18n="@@feedbackAdmin.questionTextRequired">
                      Question text is required.
                    </span>
                  }
                </div>

                @if (question.type === 'rating') {
                  <p class="hint" i18n="@@feedbackAdmin.ratingHint">
                    Students will select a 1-5 star rating.
                  </p>
                }
              </div>
            }
          </div>

          <div class="add-question">
            <div class="add-question__label" i18n="@@feedbackAdmin.addQuestionLabel">
              Add a question card
            </div>
            <div class="add-question__actions">
              <app-button variant="outline" type="button" (click)="addQuestion('rating')" (keydown.enter)="addQuestion('rating')">
                <span i18n="@@feedbackAdmin.addRating">Rating</span>
              </app-button>
              <app-button variant="outline" type="button" (click)="addQuestion('text')" (keydown.enter)="addQuestion('text')">
                <span i18n="@@feedbackAdmin.addText">Text</span>
              </app-button>
            </div>
          </div>
        </div>

          <div class="builder__footer">
          @if (formLoadError) {
            <p class="builder__error">{{ formLoadError }}</p>
          }
          @if (isLoadingForm) {
            <p class="builder__error" i18n="@@feedbackAdmin.loadingForm">Loading form details...</p>
          }
          @if (publishAttempted && formInvalid) {
            <p class="builder__error" i18n="@@feedbackAdmin.completeRequired">
              Please complete required fields before saving.
            </p>
          }
          @if (saveError) {
            <p class="builder__error">{{ saveError }}</p>
          }
          @if (savedMessage) {
            <p class="builder__success">{{ savedMessage }}</p>
          }
          <div class="builder__actions">
            <app-button class="builder__cancel" variant="outline" type="button" (click)="goBack()">
              <span i18n="@@feedbackAdmin.cancel">Cancel</span>
            </app-button>
            <app-button variant="primary" type="submit" [disabled]="formInvalid || isSaving || isLoadingForm">
              {{ saveButtonLabel }}
            </app-button>
          </div>
        </div>
      </form>
    </section>
  </main>
</app-background-div>
