<app-background-div class="student">
  <main class="student__main">
    <section class="student__hero">
      <div class="student__heading">
        <p class="student__eyebrow">Student feedback</p>
        <h1 class="student__title">Share your learning experience</h1>
        <p class="student__lead">
          Complete the active forms below to help teachers improve. Your responses are kept confidential and shared only in aggregate.
        </p>
        <div class="student__badges">
          <span class="pill pill--accent">{{ forms.length }} active forms</span>
          <span class="pill">Anonymous by design</span>
          <span class="pill pill--soft">2-4 minutes</span>
        </div>
      </div>
      <div class="student__hero-card">
        <div class="hero-stat">
          <p class="hero-stat__label">Next deadline</p>
          <p class="hero-stat__value">{{ nextDeadlineLabel }}</p>
          <p class="hero-stat__hint">Submit before the due date to be counted.</p>
        </div>
        <div class="hero-stat">
          <p class="hero-stat__label">Selected form</p>
          <p class="hero-stat__value">{{ selectedForm?.title || 'Choose a form' }}</p>
          <p class="hero-stat__hint">{{ selectedTeacherName || 'Teacher details appear here.' }}</p>
        </div>
      </div>
    </section>

    <section class="student__content">
      <div class="student__card student__card--list">
        <div class="section-header">
          <h2>Available forms</h2>
          <p>Select the evaluation you want to complete.</p>
        </div>

        @if (loadingForms) {
          <p class="state-text">Loading active forms...</p>
        } @else if (formsError) {
          <p class="state-text state-text--error">{{ formsError }}</p>
        } @else if (forms.length === 0) {
          <div class="empty-state">
            <h3>No active feedback yet</h3>
            <p>Check back soon for a new evaluation window.</p>
          </div>
        } @else {
          <div class="form-list">
            @for (form of forms; track form.id) {
              <button
                type="button"
                class="form-item"
                [class.form-item--active]="form.id === selectedFormId"
                (click)="selectForm(form.id)"
              >
                <div class="form-item__main">
                  <h3>{{ form.title }}</h3>
                  <p>{{ form.teacherName }}</p>
                </div>
                <div class="form-item__meta">
                  <span class="pill pill--ghost">
                    {{ form.endDate ? (form.endDate | date: 'mediumDate') : 'No deadline' }}
                  </span>
                  @if (isSubmitted(form.id)) {
                    <span class="pill pill--success">Submitted</span>
                  } @else {
                    <span class="pill pill--soft">Open</span>
                  }
                </div>
              </button>
            }
          </div>
        }
      </div>

      <div class="student__card student__card--form">
        <div class="section-header">
          <h2>Feedback form</h2>
          <p>Answer each question honestly. Required questions are marked.</p>
        </div>

        @if (loadingForm) {
          <p class="state-text">Loading form...</p>
        } @else if (formError) {
          <p class="state-text state-text--error">{{ formError }}</p>
        } @else if (!selectedForm) {
          <div class="empty-state empty-state--compact">
            <h3>Select a form to begin</h3>
            <p>Your questions will appear here once you choose a form.</p>
          </div>
        } @else {
          <form class="feedback-form" (ngSubmit)="onSubmit()">
            <div class="feedback-form__header">
              <div>
                <h3>{{ selectedForm.title }}</h3>
                <p>
                  {{ selectedForm.description || 'Share your experience with this course.' }}
                </p>
              </div>
              <div class="feedback-form__meta">
                <span class="pill pill--ghost">
                  {{ selectedForm.endDate ? (selectedForm.endDate | date: 'mediumDate') : 'No deadline' }}
                </span>
                <span class="pill">{{ selectedTeacherName || 'Teacher pending' }}</span>
              </div>
            </div>

            @if (isSubmitted(selectedForm.id)) {
              <div class="banner banner--success">
                Thanks. You already submitted this form.
              </div>
            }

            @if (!selectedForm.targetTeacherId) {
              <label class="form-field">
                <span class="form-label">Teacher ID <span class="required">*</span></span>
                <app-input
                  variant="outline"
                  placeholder="Enter the teacher ID"
                  [fullWidth]="true"
                  [disabled]="formLocked"
                  name="teacherId"
                  [(model)]="teacherIdOverride"
                ></app-input>
                @if (submitAttempted && !teacherIdOverride.trim()) {
                  <span class="field-error">Teacher ID is required for this form.</span>
                }
              </label>
            }

            <div class="question-list">
              @for (question of selectedForm.questions; track question.id; let i = $index) {
                <div class="question-card">
                  <div class="question-card__header">
                    <div>
                      <p class="question-card__eyebrow">Question {{ i + 1 }}</p>
                      <h4>{{ question.label }}</h4>
                    </div>
                    <span class="pill pill--ghost">
                      {{ question.type === 'RATING' ? 'Rating' : 'Text' }}
                    </span>
                  </div>

                  @if (question.type === 'RATING') {
                    <div class="rating-row">
                      <app-star-rating
                        [(rating)]="responses[question.id].rating"
                        [readOnly]="formLocked"
                      ></app-star-rating>
                      <span class="rating-value">{{ responses[question.id].rating || 0 }}/5</span>
                    </div>
                  }

                  @if (question.type === 'TEXT') {
                    <textarea
                      class="form-textarea"
                      rows="4"
                      [attr.placeholder]="question.required ? 'Share a concrete example to help the teacher' : 'Optional note'"
                      [name]="'text-' + question.id"
                      [disabled]="formLocked"
                      [(ngModel)]="responses[question.id].text"
                    ></textarea>
                  }

                  <div class="question-card__footer">
                    @if (question.required) {
                      <span class="required-pill">Required</span>
                    } @else {
                      <span class="optional-pill">Optional</span>
                    }
                    @if (isQuestionInvalid(question)) {
                      <span class="field-error">Please answer this question.</span>
                    }
                  </div>
                </div>
              }
            </div>

            <div class="feedback-form__footer">
              @if (submitAttempted && isFormInvalid) {
                <p class="state-text state-text--error">Please complete required fields before submitting.</p>
              }
              @if (submitError) {
                <p class="state-text state-text--error">{{ submitError }}</p>
              }
              @if (submitSuccess) {
                <p class="state-text state-text--success">{{ submitSuccess }}</p>
              }
              <div class="feedback-form__actions">
                <div class="footer-meta">
                  <p>{{ answeredRequiredCount }}/{{ requiredCount }} required answered</p>
                </div>
                <app-button
                  variant="primary"
                  type="submit"
                  [disabled]="isFormInvalid || formLocked"
                >
                  {{ formLocked ? 'Submitted' : (isSubmitting ? 'Submitting...' : 'Submit feedback') }}
                </app-button>
              </div>
            </div>
          </form>
        }
      </div>
    </section>
  </main>
</app-background-div>
