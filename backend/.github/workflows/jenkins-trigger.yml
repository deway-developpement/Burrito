name: Trigger Jenkins Build

on:
  push:
    branches: ["production"]
  workflow_dispatch:

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Jenkins job and wait for result
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
          JENKINS_JOB: ${{ secrets.JENKINS_JOB }}
        run: |
          set -euo pipefail

          if [ -z "${JENKINS_URL}" ] || [ -z "${JENKINS_USER}" ] || [ -z "${JENKINS_API_TOKEN}" ] || [ -z "${JENKINS_JOB}" ]; then
            echo "One or more required Jenkins secrets are missing (JENKINS_URL, JENKINS_USER, JENKINS_API_TOKEN, JENKINS_JOB)." >&2
            exit 1
          fi

          CRUMB_HEADER=$(curl -sSf --user "${JENKINS_USER}:${JENKINS_API_TOKEN}" \
            "${JENKINS_URL}/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)" || true)

          echo "Triggering Jenkins job ${JENKINS_JOB}..."
          TRIGGER_HEADERS=$(curl -isSf -X POST --user "${JENKINS_USER}:${JENKINS_API_TOKEN}" \
            ${CRUMB_HEADER:+-H "$CRUMB_HEADER"} \
            -o /dev/null -D - \
            "${JENKINS_URL}/job/${JENKINS_JOB}/build")

          QUEUE_URL=$(printf "%s" "${TRIGGER_HEADERS}" | awk '/[Ll]ocation:/{print $2}' | tr -d '\r')

          if [ -z "${QUEUE_URL:-}" ]; then
            echo "Failed to retrieve queue location from Jenkins response. Headers were:"
            echo "${TRIGGER_HEADERS}"
            exit 1
          fi

          echo "Build queued at ${QUEUE_URL}"

          echo "Waiting for build to start..."
          BUILD_URL=""
          for _ in $(seq 1 60); do
            QUEUE_STATE=$(curl -sSf --user "${JENKINS_USER}:${JENKINS_API_TOKEN}" "${QUEUE_URL}api/json")
            BUILD_URL=$(echo "${QUEUE_STATE}" | jq -r '.executable.url // empty')
            if [ -n "${BUILD_URL}" ]; then
              break
            fi
            if echo "${QUEUE_STATE}" | jq -e '.cancelled == true' >/dev/null; then
              echo "Jenkins queue item was cancelled."
              exit 1
            fi
            sleep 5
          done

          if [ -z "${BUILD_URL}" ]; then
            echo "Timed out waiting for the Jenkins build to start."
            exit 1
          fi

          echo "Build started at ${BUILD_URL}"

          echo "Waiting for build to finish..."
          RESULT=""
          for _ in $(seq 1 120); do
            BUILD_STATE=$(curl -sSf --user "${JENKINS_USER}:${JENKINS_API_TOKEN}" "${BUILD_URL}api/json")
            BUILDING=$(echo "${BUILD_STATE}" | jq -r '.building')
            RESULT=$(echo "${BUILD_STATE}" | jq -r '.result // empty')
            if [ "${BUILDING}" = "false" ]; then
              break
            fi
            sleep 5
          done

          if [ -z "${RESULT}" ]; then
            echo "Timed out waiting for Jenkins build to complete."
            exit 1
          fi

          echo "Jenkins build finished with result: ${RESULT}"

          if [ "${RESULT}" != "SUCCESS" ]; then
            exit 1
          fi
