- hosts: burrito
  become: true
  vars:
    ntp_servers:
      - "0.europe.pool.ntp.org"
      - "1.europe.pool.ntp.org"
  tasks:
    - name: Read k3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token
      no_log: true

    - name: Install chrony
      apt:
        name: chrony
        update_cache: true

    - name: Configure chrony NTP servers
      blockinfile:
        path: /etc/chrony/chrony.conf
        marker: "# {mark} ANSIBLE NTP SERVERS"
        block: |
          {% for server in ntp_servers %}
          pool {{ server }} iburst
          {% endfor %}
      register: chrony_config

    - name: Collect service facts
      service_facts:

    - name: Disable systemd-timesyncd (avoid conflicts)
      service:
        name: systemd-timesyncd
        state: stopped
        enabled: false
      when:
        - ansible_service_mgr == "systemd"
        - ansible_facts.services is defined
        - "'systemd-timesyncd.service' in ansible_facts.services"
      failed_when: false

    - name: Restart chrony if config changed
      service:
        name: chrony
        state: restarted
      when: chrony_config.changed

    - name: Ensure chrony is enabled
      service:
        name: chrony
        state: started
        enabled: true

- hosts: k3s_agents
  become: true
  vars:
    k3s_server_url: "{{ hostvars['burrito'].k3s_api_endpoint }}"
    k3s_server_ip: "{{ hostvars['burrito'].k3s_private_ip }}"
    ntp_servers:
      - "0.europe.pool.ntp.org"
      - "1.europe.pool.ntp.org"
  tasks:
    - name: Clear existing burrito.deway.fr host entry
      lineinfile:
        path: /etc/hosts
        regexp: "^.*burrito\\.deway\\.fr.*$"
        state: absent

    - name: Add burrito.deway.fr host entry
      lineinfile:
        path: /etc/hosts
        line: "{{ k3s_server_ip }} burrito.deway.fr"
        create: true

    - name: Install base dependencies
      apt:
        name:
          - curl
          - ca-certificates
          - apt-transport-https
        update_cache: true

    - name: Install chrony
      apt:
        name: chrony
        update_cache: true

    - name: Configure chrony NTP servers
      blockinfile:
        path: /etc/chrony/chrony.conf
        marker: "# {mark} ANSIBLE NTP SERVERS"
        block: |
          {% for server in ntp_servers %}
          pool {{ server }} iburst
          {% endfor %}
      register: chrony_config

    - name: Collect service facts
      service_facts:

    - name: Disable systemd-timesyncd (avoid conflicts)
      service:
        name: systemd-timesyncd
        state: stopped
        enabled: false
      when:
        - ansible_service_mgr == "systemd"
        - ansible_facts.services is defined
        - "'systemd-timesyncd.service' in ansible_facts.services"
      failed_when: false

    - name: Restart chrony if config changed
      service:
        name: chrony
        state: restarted
      when: chrony_config.changed

    - name: Ensure chrony is enabled
      service:
        name: chrony
        state: started
        enabled: true

    - name: Install k3s agent
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_URL="{{ k3s_server_url }}" \
        K3S_TOKEN="{{ hostvars['burrito'].k3s_node_token.content | b64decode | trim }}" sh -
      args:
        creates: /usr/local/bin/k3s
      no_log: true
