apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: burrito-api-gateway-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
    app: burrito
spec:
  groups:
    - name: burrito.api-gateway
      rules:
        - alert: BurritoApiGatewayHigh5xxErrorRate
          expr: |
            (
              sum(rate(http_requests_total{job="api-gateway",status=~"5.."}[5m]))
              /
              clamp_min(sum(rate(http_requests_total{job="api-gateway"}[5m])), 1)
            ) * 100 > 5
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] API Gateway 5xx error rate is high"
            description: "Over the last 10 minutes, more than 5% of API Gateway requests returned HTTP 5xx responses."

        - alert: BurritoApiGatewayTargetDown
          expr: up{job="api-gateway"} == 0
          for: 2m
          labels:
            severity: critical
            team: burrito
          annotations:
            summary: "[Burrito] API Gateway scrape target is down"
            description: "Prometheus cannot scrape the API Gateway /metrics endpoint for at least 2 minutes."

        - alert: BurritoApiGatewayInboundTrafficMissing
          expr: |
            sum(rate(istio_requests_total{
              reporter="destination",
              destination_workload_namespace="evaluation-system",
              destination_workload=~"api-gateway.*"
            }[5m])) < 0.001
          for: 20m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] Inbound edge traffic to API Gateway is missing"
            description: "No measurable inbound traffic has reached api-gateway for at least 20 minutes."

        - alert: BurritoApiGatewayLatencyP95High
          expr: |
            histogram_quantile(
              0.95,
              sum(rate(istio_request_duration_milliseconds_bucket{
                reporter="destination",
                destination_workload_namespace="evaluation-system",
                destination_workload=~"api-gateway.*"
              }[5m])) by (le)
            ) > 800
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] API Gateway latency p95 is high"
            description: "Istio p95 latency on inbound API Gateway traffic has been above 800ms for 10 minutes."

    - name: burrito.observability
      rules:
        - alert: BurritoOtelCollectorSendFailedSpans
          expr: sum(rate(otelcol_exporter_send_failed_spans[5m])) > 0
          for: 5m
          labels:
            severity: critical
            team: burrito
          annotations:
            summary: "[Burrito] OpenTelemetry Collector fails to export spans"
            description: "The collector has failed to export at least one span over the last 5 minutes."

        - alert: BurritoOtelCollectorDroppedSpans
          expr: sum(rate(otelcol_processor_dropped_spans[5m])) > 0
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] OpenTelemetry Collector is dropping spans"
            description: "At least one processor dropped spans over the last 10 minutes. Trace continuity may be degraded."

        - alert: BurritoOtelCollectorMemorySaturation
          expr: otelcol_process_memory_rss > 900000000
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] OpenTelemetry Collector memory is near saturation"
            description: "Collector RSS memory has exceeded 900MB for at least 10 minutes."

        - alert: BurritoTraceContinuityDegraded
          expr: |
            (
              clamp_min(sum(rate(otelcol_receiver_accepted_spans[5m])), 0)
              -
              clamp_min(sum(rate(otelcol_exporter_sent_spans[5m])), 0)
            )
            /
            clamp_min(sum(rate(otelcol_receiver_accepted_spans[5m])), 1) > 0.2
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] Trace continuity is degraded"
            description: "More than 20% of accepted spans are not being exported, which can create orphan or incomplete traces."

        - alert: BurritoRedisStreamConsumerLagHigh
          expr: max(redis_stream_consumer_group_pending_messages{group="analytics-ms"}) > 100
          for: 10m
          labels:
            severity: warning
            team: burrito
          annotations:
            summary: "[Burrito] Redis Streams consumer lag is high"
            description: "analytics-ms consumer group has more than 100 pending stream messages for at least 10 minutes."
